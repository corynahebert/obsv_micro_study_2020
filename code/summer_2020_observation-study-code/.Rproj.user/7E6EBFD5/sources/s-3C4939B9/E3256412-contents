### PERMANOVA and NMDS of micro field exp

## loading data 

micro_data <- read.csv("Micro_exp_2.csv")
head(micro_data)

#I do not want R to use exponential notation
options(scipen=999)

## load packages 

library(tidyverse)
library(vegan)
library(dplyr)

## subset peak data 

peakplants <- subset(micro_data, exp_day == 82)

peakplants$block<- as.factor(peakplants$block)
peakplants$exp_day<- as.factor(peakplants$exp_day)
peakplants$micro<- as.factor(peakplants$micro)
peakplants$seed<- as.factor(peakplants$seed)
peakplants$BOMA<- as.numeric(peakplants$BOMA)
peakplants$SCAC<- as.numeric(peakplants$SCAC)
peakplants$ELPA<- as.numeric(peakplants$ELPA)
peakplants$DISP<- as.numeric(peakplants$DISP)
peakplants$PHAU<- as.numeric(peakplants$PHAU)
peakplants$POMO<- as.numeric(peakplants$POMO)
peakplants$BICE<- as.numeric(peakplants$BICE)
peakplants$RUMA<- as.numeric(peakplants$RUMA)
peakplants$BOMA<- as.numeric(peakplants$BOMA)
peakplants$EPCI<- as.numeric(peakplants$EPCI)
peakplants$TYPHA<- as.numeric(peakplants$TYPHA)

levels(peakplants$seed)



str(peakplants)



## averages of all 12 treatments ------

peakdataMeans <- peakplants %>% 
  group_by(micro, seed) 

str(peakdataMeans)

## permanova -----

#dont select rare species in less than 10% of plots.
#10% of 27 plots at FB is 2.7, so if the species is present 
#(present greater than T or 0.5)
#in 3 or less plots, get rid of the 
#species for this analysis (it will throw off the NMDS)

FBperm<- peakplants %>%
  dplyr::select(c(micro, seed, block, 
                  BICE, BOMA, DISP,PHAU, POMO, RUMA, SCAC, TYPHA))


#permanova with just species in > 10% or more of plots


view(FBperm)

#select the rows that are the response (all species)
permanova<- adonis(FBperm[,4:11] ~ FBperm$micro * FBperm$seed, 
                   strata=FBperm$block,  #block variance, 
                   na.rm=TRUE, by=NULL)
permanova


#permanova(drop controls)
FBperm2<- FBperm[1:24,]

permanovad<- adonis(FBperm2[,6:13] ~ FBperm2$mixtrt * FBperm2$densitytrt, 
                    #+ FBperm$ ,
                    strata=FBperm2$block,  #block variance, 
                    na.rm=TRUE, by=NULL)
permanovad



#permanova FB with all species in plots (for comparison)
FBsuballspp<- enviromerged2 %>%
  filter(site %in% "FB")%>%
  dplyr::select(c(SBT,site, block, mixtrt, densitytrt, water_cm, BICE, BOMA, 
                  DISP, ELPA, LEMI, PHAU, RUMA, SCAC, Typha,
                  algae_cov, cheno_spp, ECCR, EPCI, POMO, RASC, 
                  RUST, SCAM, SOAS))

FBplots<-FBsuballspp

str(FBplots)

permanova5<- adonis(FBplots[,7:24] ~ FBplots$mixtrt * FBplots$densitytrt, 
                    strata=FBplots$block,  #block variance, 
                    na.rm=TRUE, by=NULL)
permanova5

##mixtrt comes before density in the formula, because
#a priori meaningful order. Significance stays the same between 
#removing species and not, so
#we will remove species in less than 10% of plots, so that we are consistant
#with the NMDS which requires the removal of rare species.

## NMDS for peak data ------------

FB_nmds <- peakplants %>%
  dplyr:: select(c(block, micro, seed, BICE, BOMA, DISP, 
                   PHAU, POMO, RUMA, SCAC, TYPHA))
str(peakplants)

str(FB_nmds)

view(FB_nmds)

## community by species matrix 

FB_nmds$treatmentname <- paste(FB_nmds$seed,FB_nmds$micro,FB_nmds$block,sep="_")
rownames(FB_nmds) <- FB_nmds$treatmentname

FBplotsNMDS<- FB_nmds %>%
  dplyr::select(-c(micro, block, seed, treatmentname))

plotdatamatrix<- as.matrix(FBplotsNMDS)
view(plotdatamatrix)

str(FB_nmds)

#NMDS

FB_NMDS <- metaMDS(comm = plotdatamatrix,
                    distance = "bray") 

plot(FB_NMDS)

# our community matrix, k= # of reduced dimensions

FB_NMDS

## extracting species scores --------

stressplot(FB_NMDS)

#extract scores and make sure trt columns added
data.scores <- as.data.frame(scores(FB_NMDS))#Using the scores function to extract the site scores and convert to a data.frame
data.scores$treatment <- rownames(data.scores)  # create a column of site names, from the rownames of data.scores
data.scores$seed <- FBplotsNMDS$seed
data.scores$micro <- FBplotsNMDS$micro
data.scores$block <- FBplotsNMDS$block

#species scores
species.scores <- as.data.frame(scores(FB_NMDS, "species"))  #Using the scores function from vegan to extract the species scores and convert to a data.frame
species.scores$species <- rownames(species.scores)  # create a column of species, from the rownames of species.scores

view(species.scores)
view(data.scores)

### Micro for plotting----
##density elipses
NMDS_Data <- data.frame(MDS1=FB_NMDS$points[,1], MDS2=FB_NMDS$points[,2], group=data.scores$treatment)
ord <- ordiellipse(FB_NMDS, data.scores$treatment, display = "sites", kind= "se", conf = 0.95, label = T, draw="lines", col="red") 

view(NMDS_Data)

veganCovEllipse <- function (cov, center = c(0, 0), scale = 1, npoints = 100){
  theta <- (0:npoints) * 2 * pi/npoints
  Circle <- cbind(cos(theta), sin(theta))
  t(center + scale * t(Circle %*% chol(cov)))
}

df_ell <- data.frame()
for(g in levels(NMDS_Data$group)){
  df_ell <- rbind(df_ell, cbind(as.data.frame(with(NMDS_Data[NMDS_Data$group==g,],
                                                   veganCovEllipse(ord[[g]]$cov,ord[[g]]$center,ord[[g]]$scale))), group=g))
}

view(df_ell)

ggplot(data = NMDS_Data, aes(MDS1, MDS2)) + 
  geom_point(data = NMDS_Data, aes(color = group)) +
  geom_path(data=df_ell, aes(x=NMDS1, y=NMDS2, linetype=g), size=1)

#mix elipses
NMDS_Data2 <- data.frame(MDS1=FB_NMDS$points[,1], MDS2=FB_NMDS$points[,2], group=data.scores$Mix)
ord <- ordiellipse(FB_NMDS, data.scores$Mix, display = "sites", kind= "se", conf = 0.95, label = T, draw="lines", col="red") 

veganCovEllipse <- function (cov, center = c(0, 0), scale = 1, npoints = 100){
  theta <- (0:npoints) * 2 * pi/npoints
  Circle <- cbind(cos(theta), sin(theta))
  t(center + scale * t(Circle %*% chol(cov)))
}

df_ellM <- data.frame()
for(g in levels(NMDS_Data2$group)){
  df_ellM <- rbind(df_ellM, cbind(as.data.frame(with(NMDS_Data2[NMDS_Data2$group==g,],
                                                     veganCovEllipse(ord[[g]]$cov,ord[[g]]$center,ord[[g]]$scale))), group=g))
}

ggplot(data = NMDS_Data2, aes(MDS1, MDS2)) + 
  geom_point(aes(color = group)) +
  geom_path(data=df_ellM, aes(x=NMDS1, y=NMDS2, linetype=group), size=1)


#plotting----

view

ggplot() + 
  geom_text(data=species.scores,aes(x=NMDS1,y=NMDS2,label=species),alpha=0.5, position=position_jitter(width=.02 ,height=.05)) +  # add the species labels
  geom_point(data=data.scores,aes(x=NMDS1,y=NMDS2,shape=treatment,colour=treatment),size=3) + # add the point markers
  scale_colour_manual("Density", values=c("0X" = "blue", "1X" = "darkgreen", "3X"= "red")) +
  coord_equal() +
  theme_bw()+
  ggtitle("Plant communities at Farmington Bay")+
  theme(plot.title = element_text(hjust = 0.5))

ggsave("Composition x Density Experiment/Composition x Density Data/NMDS_plots/FB_NMDSAug6.jpeg", width=12, height=8, unit="in", dpi=300)

#enviroconditons forFB

#round SBT to categorical


FBenviros<- enviromerged2 %>%
  filter(site %in% "FB")%>%
  dplyr::select(c(site, mixtrt, densitytrt, meanSBT, block, meanwaterdepth, 
                  meanWW,Meandailymeans, maxdailymean, 
                  mindailymean, rangedailymean))

FBenviros$catgSBT<-round(FBenviros$meanSBT)
FBenviros$catgSBT<-as.character(FBenviros$catgSBT)
FBenviros$catgSBT<-as.factor(FBenviros$catgSBT)

FBenv = FBenviros[,6:12]


FBen = envfit(FB_NMDS, FBenv, permutations = 999, na.rm = TRUE)

FBen

plot(FB_NMDS)
plot(FBen)


##extract coordinates from FB env for plotting
#by blocks
FBen_coord_cont = as.data.frame(scores(FBen, "vectors")) * ordiArrowMul(FBen)
FBen_coord_cat = as.data.frame(scores(FBen, "factors")) * ordiArrowMul(FBen)

##all enviro conditions
#plot FB communities plus envfit vectors
ggplot() + 
  geom_text(data=species.scores,aes(x=NMDS1,y=NMDS2,label=species),alpha=0.5, position=position_jitter(width=.02 ,height=.05)) +  # add the species labels
  geom_point(data=data.scores,aes(x=NMDS1,y=NMDS2,colour=Mix),size=3) + # add the point markers
  scale_colour_manual("Mix", values=c("Unseeded, unweeded control" = "red", 
                                      "0% fast-growing natives mix"= "darkorange3",
                                      "10% fast-growing natives mix" = "goldenrod2",
                                      "25% fast-growing natives mix"= "darkgreen",
                                      "100% fast-growing natives mix"= "blue"))+
  scale_linetype_manual("Density", values= c("0X"="dotted", "1X"= "dashed", "3X"= "solid"))+
  coord_equal() +
  theme_bw()+
  ggtitle("Plant communities at Famington Bay")+
  theme(plot.title = element_text(hjust = 0.5))+
  geom_segment(aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2), 
               data = FBen_coord_cont, size =1, alpha = 0.5, colour = "grey30", position=position_jitter(width=.0 ,height=.0))+
  geom_text(data = FBen_coord_cont, aes(x = NMDS1, y = NMDS2+0.04), 
            label = row.names(FBen_coord_cont), colour = "black",size= 3.5, 
            fontface = "bold", position=position_jitter(width=.0 ,height=.05))+
  geom_point(data = FBen_coord_cat, aes(x = NMDS1, y = NMDS2), 
             shape = "diamond", alpha = 0.3, size= 4, colour = "navy", position=position_jitter(width=.0 ,height=.0))+
  geom_text(data = FBen_coord_cat, aes(x = NMDS1, y = NMDS2+0.04), 
            label = row.names(FBen_coord_cat), colour = "black",size= 3.5, fontface = "bold", position=position_jitter(width=.0 ,height=.0))

#geom_path(data=df_ell, aes(x=NMDS1, y=NMDS2, linetype=group), size=1)
#geom_path(data=df_ellM, aes(x=NMDS1, y=NMDS2, color=group), size=1, alpha = .5)

ggsave("Composition x Density Experiment/Composition x Density Data/NMDS_plots/FB_NMDS_allconditionsAug6.jpeg", width=12, height=8, unit="in", dpi=300)


#no enviro conditions just density ellipses
ggplot() + 
  geom_text(data=species.scores,aes(x=NMDS1,y=NMDS2,label=species),alpha=0.5, position=position_jitter(width=.02 ,height=.05)) +  # add the species labels
  geom_point(data=data.scores,aes(x=NMDS1,y=NMDS2,colour=Mix),size=3) + # add the point markers
  scale_colour_manual("Mix", values=c("Unseeded, unweeded control" = "red", 
                                      "0% fast-growing natives mix"= "darkorange3",
                                      "10% fast-growing natives mix" = "goldenrod2",
                                      "25% fast-growing natives mix"= "darkgreen",
                                      "100% fast-growing natives mix"= "blue"))+
  scale_linetype_manual("Density", values= c("0X"="dotted", "1X"= "dashed", "3X"= "solid"))+
  coord_equal() +
  theme_bw()+
  ggtitle("Plant communities at Famington Bay")+
  theme(plot.title = element_text(hjust = 0.5))+
  #geom_segment(aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2), 
  #            data = FBen_coord_cont, size =1, alpha = 0.5, colour = "grey30", position=position_jitter(width=.0 ,height=.0))+
  #geom_text(data = FBen_coord_cont, aes(x = NMDS1, y = NMDS2+0.04), 
  #         label = row.names(FBen_coord_cont), colour = "black",size= 3.5, 
  #         fontface = "bold", position=position_jitter(width=.0 ,height=.0))+
  geom_path(data=df_ell, aes(x=NMDS1, y=NMDS2, linetype=group), size=1)
#geom_path(data=df_ellM, aes(x=NMDS1, y=NMDS2, color=group), size=1, alpha = .5)

ggsave("Composition x Density Experiment/Composition x Density Data/NMDS_plots/FB_NMDS_densityellipAug6.jpeg", width=12, height=8, unit="in", dpi=300)


#no enviro conditions just mix ellipses
ggplot() + 
  geom_text(data=species.scores,aes(x=NMDS1,y=NMDS2,label=species),alpha=0.5, position=position_jitter(width=.02 ,height=.05)) +  # add the species labels
  geom_point(data=data.scores,aes(x=NMDS1,y=NMDS2,colour=Mix),size=3) + # add the point markers
  scale_colour_manual("Mix", values=c("Unseeded, unweeded control" = "red", 
                                      "0% fast-growing natives mix"= "darkorange3",
                                      "10% fast-growing natives mix" = "goldenrod2",
                                      "25% fast-growing natives mix"= "darkgreen",
                                      "100% fast-growing natives mix"= "blue"))+
  scale_linetype_manual("Density", values= c("0X"="dotted", "1X"= "dashed", "3X"= "solid"))+
  coord_equal() +
  theme_bw()+
  ggtitle("Plant communities at Famington Bay")+
  theme(plot.title = element_text(hjust = 0.5))+
  #geom_segment(aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2), 
  #            data = FBen_coord_cont, size =1, alpha = 0.5, colour = "grey30", position=position_jitter(width=.0 ,height=.0))+
  #geom_text(data = FBen_coord_cont, aes(x = NMDS1, y = NMDS2+0.04), 
  #         label = row.names(FBen_coord_cont), colour = "black",size= 3.5, 
  #         fontface = "bold", position=position_jitter(width=.0 ,height=.0))+
  #geom_path(data=df_ell, aes(x=NMDS1, y=NMDS2, linetype=group), size=1)
  geom_path(data=df_ellM, aes(x=NMDS1, y=NMDS2, color=group), size=1, alpha = .5)

ggsave("Composition x Density Experiment/Composition x Density Data/NMDS_plots/FB_NMDS_MixellipAug6.jpeg", width=12, height=8, unit="in", dpi=300)


  
